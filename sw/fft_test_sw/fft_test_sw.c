

//#define __riscv__
//#define LED_DELAY 10

//#include <stdio.h>
#include <stdint.h>

//#include <spi.h>
#include <gpio.h>
//#include <uart.h>
//#include <utils.h>
//#include <pulpino.h>

#include <fft.h>


#define N 128
#define N_LOG2 7
#define COEF_SIZE 448


int main()
{




  set_pin_function(11, FUNC_GPIO);
  set_gpio_pin_direction(11, DIR_OUT);
  set_gpio_pin_value(11, 0);


  set_pin_function(10, FUNC_GPIO);
  set_gpio_pin_direction(10, DIR_OUT);
  set_gpio_pin_value(10, 0);

  set_pin_function(9, FUNC_GPIO);
  set_gpio_pin_direction(9, DIR_OUT);
  set_gpio_pin_value(9, 0);

    set_pin_function(8, FUNC_GPIO);
  set_gpio_pin_direction(8, DIR_OUT);
  set_gpio_pin_value(8, 0);


  uint32_t n = N;
  uint32_t n_log2 = N_LOG2;





  // Pre - calculated coef set for 8 points FFT
  struct complex coef[COEF_SIZE] = {
{     0, 32767},
{     0, 32767},
{     0, 32767},
{     0, 32767},
{     0, 32767},
{     0, 32767},
{     0, 32767},
{     0, 32767},
{     0, 32767},
{     0, 32767},
{     0, 32767},
{     0, 32767},
{     0, 32767},
{     0, 32767},
{     0, 32767},
{     0, 32767},
{     0, 32767},
{     0, 32767},
{     0, 32767},
{     0, 32767},
{     0, 32767},
{     0, 32767},
{     0, 32767},
{     0, 32767},
{     0, 32767},
{     0, 32767},
{     0, 32767},
{     0, 32767},
{     0, 32767},
{     0, 32767},
{     0, 32767},
{     0, 32767},
{     0, 32767},
{     0, 32767},
{     0, 32767},
{     0, 32767},
{     0, 32767},
{     0, 32767},
{     0, 32767},
{     0, 32767},
{     0, 32767},
{     0, 32767},
{     0, 32767},
{     0, 32767},
{     0, 32767},
{     0, 32767},
{     0, 32767},
{     0, 32767},
{     0, 32767},
{     0, 32767},
{     0, 32767},
{     0, 32767},
{     0, 32767},
{     0, 32767},
{     0, 32767},
{     0, 32767},
{     0, 32767},
{     0, 32767},
{     0, 32767},
{     0, 32767},
{     0, 32767},
{     0, 32767},
{     0, 32767},
{     0, 32767},
{     0, 32767},
{ 32768,     0},
{     0, 32767},
{ 32768,     0},
{     0, 32767},
{ 32768,     0},
{     0, 32767},
{ 32768,     0},
{     0, 32767},
{ 32768,     0},
{     0, 32767},
{ 32768,     0},
{     0, 32767},
{ 32768,     0},
{     0, 32767},
{ 32768,     0},
{     0, 32767},
{ 32768,     0},
{     0, 32767},
{ 32768,     0},
{     0, 32767},
{ 32768,     0},
{     0, 32767},
{ 32768,     0},
{     0, 32767},
{ 32768,     0},
{     0, 32767},
{ 32768,     0},
{     0, 32767},
{ 32768,     0},
{     0, 32767},
{ 32768,     0},
{     0, 32767},
{ 32768,     0},
{     0, 32767},
{ 32768,     0},
{     0, 32767},
{ 32768,     0},
{     0, 32767},
{ 32768,     0},
{     0, 32767},
{ 32768,     0},
{     0, 32767},
{ 32768,     0},
{     0, 32767},
{ 32768,     0},
{     0, 32767},
{ 32768,     0},
{     0, 32767},
{ 32768,     0},
{     0, 32767},
{ 32768,     0},
{     0, 32767},
{ 32768,     0},
{     0, 32767},
{ 32768,     0},
{     0, 32767},
{ 32768,     0},
{     0, 32767},
{ 32768,     0},
{     0, 32767},
{ 32768,     0},
{     0, 32767},
{ 32768,     0},
{     0, 32767},
{ 42366, 23170},
{ 32768,     0},
{ 42366, 42366},
{     0, 32767},
{ 42366, 23170},
{ 32768,     0},
{ 42366, 42366},
{     0, 32767},
{ 42366, 23170},
{ 32768,     0},
{ 42366, 42366},
{     0, 32767},
{ 42366, 23170},
{ 32768,     0},
{ 42366, 42366},
{     0, 32767},
{ 42366, 23170},
{ 32768,     0},
{ 42366, 42366},
{     0, 32767},
{ 42366, 23170},
{ 32768,     0},
{ 42366, 42366},
{     0, 32767},
{ 42366, 23170},
{ 32768,     0},
{ 42366, 42366},
{     0, 32767},
{ 42366, 23170},
{ 32768,     0},
{ 42366, 42366},
{     0, 32767},
{ 42366, 23170},
{ 32768,     0},
{ 42366, 42366},
{     0, 32767},
{ 42366, 23170},
{ 32768,     0},
{ 42366, 42366},
{     0, 32767},
{ 42366, 23170},
{ 32768,     0},
{ 42366, 42366},
{     0, 32767},
{ 42366, 23170},
{ 32768,     0},
{ 42366, 42366},
{     0, 32767},
{ 42366, 23170},
{ 32768,     0},
{ 42366, 42366},
{     0, 32767},
{ 42366, 23170},
{ 32768,     0},
{ 42366, 42366},
{     0, 32767},
{ 42366, 23170},
{ 32768,     0},
{ 42366, 42366},
{     0, 32767},
{ 42366, 23170},
{ 32768,     0},
{ 42366, 42366},
{     0, 32767},
{ 52996, 30274},
{ 42366, 23170},
{ 35262, 12540},
{ 32768,     0},
{ 35262, 52996},
{ 42366, 42366},
{ 52996, 35262},
{     0, 32767},
{ 52996, 30274},
{ 42366, 23170},
{ 35262, 12540},
{ 32768,     0},
{ 35262, 52996},
{ 42366, 42366},
{ 52996, 35262},
{     0, 32767},
{ 52996, 30274},
{ 42366, 23170},
{ 35262, 12540},
{ 32768,     0},
{ 35262, 52996},
{ 42366, 42366},
{ 52996, 35262},
{     0, 32767},
{ 52996, 30274},
{ 42366, 23170},
{ 35262, 12540},
{ 32768,     0},
{ 35262, 52996},
{ 42366, 42366},
{ 52996, 35262},
{     0, 32767},
{ 52996, 30274},
{ 42366, 23170},
{ 35262, 12540},
{ 32768,     0},
{ 35262, 52996},
{ 42366, 42366},
{ 52996, 35262},
{     0, 32767},
{ 52996, 30274},
{ 42366, 23170},
{ 35262, 12540},
{ 32768,     0},
{ 35262, 52996},
{ 42366, 42366},
{ 52996, 35262},
{     0, 32767},
{ 52996, 30274},
{ 42366, 23170},
{ 35262, 12540},
{ 32768,     0},
{ 35262, 52996},
{ 42366, 42366},
{ 52996, 35262},
{     0, 32767},
{ 52996, 30274},
{ 42366, 23170},
{ 35262, 12540},
{ 32768,     0},
{ 35262, 52996},
{ 42366, 42366},
{ 52996, 35262},
{     0, 32767},
{ 59143, 32138},
{ 52996, 30274},
{ 47331, 27246},
{ 42366, 23170},
{ 38290, 18205},
{ 35262, 12540},
{ 33398,  6393},
{ 32768,     0},
{ 33398, 59143},
{ 35262, 52996},
{ 38290, 47331},
{ 42366, 42366},
{ 47331, 38290},
{ 52996, 35262},
{ 59143, 33398},
{     0, 32767},
{ 59143, 32138},
{ 52996, 30274},
{ 47331, 27246},
{ 42366, 23170},
{ 38290, 18205},
{ 35262, 12540},
{ 33398,  6393},
{ 32768,     0},
{ 33398, 59143},
{ 35262, 52996},
{ 38290, 47331},
{ 42366, 42366},
{ 47331, 38290},
{ 52996, 35262},
{ 59143, 33398},
{     0, 32767},
{ 59143, 32138},
{ 52996, 30274},
{ 47331, 27246},
{ 42366, 23170},
{ 38290, 18205},
{ 35262, 12540},
{ 33398,  6393},
{ 32768,     0},
{ 33398, 59143},
{ 35262, 52996},
{ 38290, 47331},
{ 42366, 42366},
{ 47331, 38290},
{ 52996, 35262},
{ 59143, 33398},
{     0, 32767},
{ 59143, 32138},
{ 52996, 30274},
{ 47331, 27246},
{ 42366, 23170},
{ 38290, 18205},
{ 35262, 12540},
{ 33398,  6393},
{ 32768,     0},
{ 33398, 59143},
{ 35262, 52996},
{ 38290, 47331},
{ 42366, 42366},
{ 47331, 38290},
{ 52996, 35262},
{ 59143, 33398},
{     0, 32767},
{ 62324, 32610},
{ 59143, 32138},
{ 56024, 31357},
{ 52996, 30274},
{ 50089, 28899},
{ 47331, 27246},
{ 44748, 25330},
{ 42366, 23170},
{ 40206, 20788},
{ 38290, 18205},
{ 36637, 15447},
{ 35262, 12540},
{ 34179,  9512},
{ 33398,  6393},
{ 32926,  3212},
{ 32768,     0},
{ 32926, 62324},
{ 33398, 59143},
{ 34179, 56024},
{ 35262, 52996},
{ 36637, 50089},
{ 38290, 47331},
{ 40206, 44748},
{ 42366, 42366},
{ 44748, 40206},
{ 47331, 38290},
{ 50089, 36637},
{ 52996, 35262},
{ 56024, 34179},
{ 59143, 33398},
{ 62324, 32926},
{     0, 32767},
{ 62324, 32610},
{ 59143, 32138},
{ 56024, 31357},
{ 52996, 30274},
{ 50089, 28899},
{ 47331, 27246},
{ 44748, 25330},
{ 42366, 23170},
{ 40206, 20788},
{ 38290, 18205},
{ 36637, 15447},
{ 35262, 12540},
{ 34179,  9512},
{ 33398,  6393},
{ 32926,  3212},
{ 32768,     0},
{ 32926, 62324},
{ 33398, 59143},
{ 34179, 56024},
{ 35262, 52996},
{ 36637, 50089},
{ 38290, 47331},
{ 40206, 44748},
{ 42366, 42366},
{ 44748, 40206},
{ 47331, 38290},
{ 50089, 36637},
{ 52996, 35262},
{ 56024, 34179},
{ 59143, 33398},
{ 62324, 32926},
{     0, 32767},
{ 63928, 32729},
{ 62324, 32610},
{ 60728, 32413},
{ 59143, 32138},
{ 57574, 31786},
{ 56024, 31357},
{ 54497, 30853},
{ 52996, 30274},
{ 51526, 29622},
{ 50089, 28899},
{ 48690, 28106},
{ 47331, 27246},
{ 46016, 26320},
{ 44748, 25330},
{ 43530, 24279},
{ 42366, 23170},
{ 41257, 22006},
{ 40206, 20788},
{ 39216, 19520},
{ 38290, 18205},
{ 37430, 16846},
{ 36637, 15447},
{ 35914, 14010},
{ 35262, 12540},
{ 34683, 11039},
{ 34179,  9512},
{ 33750,  7962},
{ 33398,  6393},
{ 33123,  4808},
{ 32926,  3212},
{ 32807,  1608},
{ 32768,     0},
{ 32807, 63928},
{ 32926, 62324},
{ 33123, 60728},
{ 33398, 59143},
{ 33750, 57574},
{ 34179, 56024},
{ 34683, 54497},
{ 35262, 52996},
{ 35914, 51526},
{ 36637, 50089},
{ 37430, 48690},
{ 38290, 47331},
{ 39216, 46016},
{ 40206, 44748},
{ 41257, 43530},
{ 42366, 42366},
{ 43530, 41257},
{ 44748, 40206},
{ 46016, 39216},
{ 47331, 38290},
{ 48690, 37430},
{ 50089, 36637},
{ 51526, 35914},
{ 52996, 35262},
{ 54497, 34683},
{ 56024, 34179},
{ 57574, 33750},
{ 59143, 33398},
{ 60728, 33123},
{ 62324, 32926},
{ 63928, 32807}
  };


  struct complex array_in[N] = {
{     0, 32767},
{     0, 32767},
{     0, 32767},
{     0, 32767},
{     0, 32767},
{     0, 32767},
{     0, 32767},
{     0, 32767},
{     0, 32767},
{     0, 32767},
{     0, 32767},
{     0, 32767},
{     0, 32767},
{     0, 32767},
{     0, 32767},
{     0, 32767},
{     0, 32767},
{     0, 32767},
{     0, 32767},
{     0, 32767},
{     0, 32767},
{     0, 32767},
{     0, 32767},
{     0, 32767},
{     0, 32767},
{     0, 32767},
{     0, 32767},
{     0, 32767},
{     0, 32767},
{     0, 32767},
{     0, 32767},
{     0, 32767},
{     0, 32767},
{     0, 32767},
{     0, 32767},
{     0, 32767},
{     0, 32767},
{     0, 32767},
{     0, 32767},
{     0, 32767},
{     0, 32767},
{     0, 32767},
{     0, 32767},
{     0, 32767},
{     0, 32767},
{     0, 32767},
{     0, 32767},
{     0, 32767},
{     0, 32767},
{     0, 32767},
{     0, 32767},
{     0, 32767},
{     0, 32767},
{     0, 32767},
{     0, 32767},
{     0, 32767},
{     0, 32767},
{     0, 32767},
{     0, 32767},
{     0, 32767},
{     0, 32767},
{     0, 32767},
{     0, 32767},
{     0, 32767},
{     0, 32767},
{ 32768,     0},
{     0, 32767},
{ 32768,     0},
{     0, 32767},
{ 32768,     0},
{     0, 32767},
{ 32768,     0},
{     0, 32767},
{ 32768,     0},
{     0, 32767},
{ 32768,     0},
{     0, 32767},
{ 32768,     0},
{     0, 32767},
{ 32768,     0},
{     0, 32767},
{ 32768,     0},
{     0, 32767},
{ 32768,     0},
{     0, 32767},
{ 32768,     0},
{     0, 32767},
{ 32768,     0},
{     0, 32767},
{ 32768,     0},
{     0, 32767},
{ 32768,     0},
{     0, 32767},
{ 32768,     0},
{     0, 32767},
{ 32768,     0},
{     0, 32767},
{ 32768,     0},
{     0, 32767},
{ 32768,     0},
{     0, 32767},
{ 32768,     0},
{     0, 32767},
{ 32768,     0},
{     0, 32767},
{ 32768,     0},
{     0, 32767},
{ 32768,     0},
{     0, 32767},
{ 32768,     0},
{     0, 32767},
{ 32768,     0},
{     0, 32767},
{ 32768,     0},
{     0, 32767},
{ 32768,     0},
{     0, 32767},
{ 32768,     0},
{     0, 32767},
{ 32768,     0},
{     0, 32767},
{ 32768,     0},
{     0, 32767},
{ 32768,     0},
{     0, 32767},
{ 32768,     0},
{     0, 32767},
{ 32768,     0}
  };


  struct complex array_out[N];
  uint32_t array_out_abs[N];


  uint32_t simd_coef[COEF_SIZE];
  for (int i = 0; i < COEF_SIZE; ++i)
  {
    simd_coef[i] = convert_struct_to_simd(coef[i]);
  }


  uint32_t simd_array_in[N];
  for (int i = 0; i < N; ++i)
  {
    simd_array_in[i] = convert_struct_to_simd(array_in[i]);
  }


  uint32_t simd_array_out[N];
  uint32_t simd_array_out_abs[N];


  set_gpio_pin_value(10, 1);


  fft (n, n_log2,
          array_in,
          coef,
          array_out);


  for (int i = 0; i < N; ++i)
  {
    array_out_abs[i] = fast_abs(array_out[i]);
  }


  set_gpio_pin_value(9, 1);



  fft_hw (n, n_log2,
          simd_array_in,
          simd_coef,
          simd_array_out);

  for (int i = 0; i < N; ++i)
  {
    simd_array_out_abs[i] = fast_abs_hw(simd_array_out[i]);
  }



  set_gpio_pin_value(8, 1);



while(1);

}















/*





*/